!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define("../lib/bullseye",[],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.bullseye=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function bullseye(el,target,options){function sleep(){tailorOptions.sleeping=!0}function readNull(){return read()}function read(readings){var bounds=target.getBoundingClientRect(),scrollTop=document.body.scrollTop||document.documentElement.scrollTop;return tailor?(readings=tailor.read(),{x:(readings.absolute?0:bounds.left)+readings.x,y:(readings.absolute?0:bounds.top)+scrollTop+readings.y+20}):{x:bounds.left,y:bounds.top+scrollTop}}function update(readings){write(readings)}function write(readings){if(destroyed)throw new Error("Bullseye can't refresh after being destroyed. Create another instance instead.");if(tailor&&!readings)return tailorOptions.sleeping=!1,void tailor.refresh();var p=read(readings);tailor||target===el||(p.y+=target.offsetHeight),el.style.left=p.x+"px",el.style.top=p.y+"px"}function destroy(){tailor&&tailor.destroy(),crossvent.remove(window,"resize",throttledWrite),destroyed=!0}var o=options,domTarget=target&&target.tagName;domTarget||2!==arguments.length||(o=target),domTarget||(target=el),o||(o={});var destroyed=!1,throttledWrite=throttle(write,30),tailorOptions={update:o.autoupdateToCaret!==!1&&update},tailor=o.caret&&tailormade(target,tailorOptions);return write(),o.tracking!==!1&&crossvent.add(window,"resize",throttledWrite),{read:readNull,refresh:write,destroy:destroy,sleep:sleep}}var crossvent=require("crossvent"),throttle=require("./throttle"),tailormade=require("./tailormade");module.exports=bullseye},{"./tailormade":14,"./throttle":15,crossvent:3}],2:[function(require,module,exports){(function(global){function useNative(){try{var p=new NativeCustomEvent("cat",{detail:{foo:"bar"}});return"cat"===p.type&&"bar"===p.detail.foo}catch(e){}return!1}var NativeCustomEvent=global.CustomEvent;module.exports=useNative()?NativeCustomEvent:"function"==typeof document.createEvent?function(type,params){var e=document.createEvent("CustomEvent");return params?e.initCustomEvent(type,params.bubbles,params.cancelable,params.detail):e.initCustomEvent(type,!1,!1,void 0),e}:function(type,params){var e=document.createEventObject();return e.type=type,params?(e.bubbles=Boolean(params.bubbles),e.cancelable=Boolean(params.cancelable),e.detail=params.detail):(e.bubbles=!1,e.cancelable=!1,e.detail=void 0),e}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(require,module,exports){(function(global){"use strict";function addEventEasy(el,type,fn,capturing){return el.addEventListener(type,fn,capturing)}function addEventHard(el,type,fn){return el.attachEvent("on"+type,wrap(el,type,fn))}function removeEventEasy(el,type,fn,capturing){return el.removeEventListener(type,fn,capturing)}function removeEventHard(el,type,fn){return el.detachEvent("on"+type,unwrap(el,type,fn))}function fabricateEvent(el,type,model){function makeClassicEvent(){var e;return doc.createEvent?(e=doc.createEvent("Event"),e.initEvent(type,!0,!0)):doc.createEventObject&&(e=doc.createEventObject()),e}function makeCustomEvent(){return new customEvent(type,{detail:model})}var e=-1===eventmap.indexOf(type)?makeCustomEvent():makeClassicEvent();el.dispatchEvent?el.dispatchEvent(e):el.fireEvent("on"+type,e)}function wrapperFactory(el,type,fn){return function(originalEvent){var e=originalEvent||global.event;e.target=e.target||e.srcElement,e.preventDefault=e.preventDefault||function(){e.returnValue=!1},e.stopPropagation=e.stopPropagation||function(){e.cancelBubble=!0},e.which=e.which||e.keyCode,fn.call(el,e)}}function wrap(el,type,fn){var wrapper=unwrap(el,type,fn)||wrapperFactory(el,type,fn);return hardCache.push({wrapper:wrapper,element:el,type:type,fn:fn}),wrapper}function unwrap(el,type,fn){var i=find(el,type,fn);if(i){var wrapper=hardCache[i].wrapper;return hardCache.splice(i,1),wrapper}}function find(el,type,fn){var i,item;for(i=0;i<hardCache.length;i++)if(item=hardCache[i],item.element===el&&item.type===type&&item.fn===fn)return i}var customEvent=require("custom-event"),eventmap=require("./eventmap"),doc=document,addEvent=addEventEasy,removeEvent=removeEventEasy,hardCache=[];global.addEventListener||(addEvent=addEventHard,removeEvent=removeEventHard),module.exports={add:addEvent,remove:removeEvent,fabricate:fabricateEvent}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./eventmap":4,"custom-event":2}],4:[function(require,module,exports){(function(global){"use strict";var eventmap=[],eventname="",ron=/^on/;for(eventname in global)ron.test(eventname)&&eventmap.push(eventname.slice(2));module.exports=eventmap}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(require,module,exports){(function(global){"use strict";var getSelection,doc=global.document,getSelectionRaw=require("./getSelectionRaw"),getSelectionNullOp=require("./getSelectionNullOp"),getSelectionSynthetic=require("./getSelectionSynthetic"),isHost=require("./isHost");getSelection=isHost.method(global,"getSelection")?getSelectionRaw:"object"==typeof doc.selection&&doc.selection?getSelectionSynthetic:getSelectionNullOp,module.exports=getSelection}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./getSelectionNullOp":6,"./getSelectionRaw":7,"./getSelectionSynthetic":8,"./isHost":9}],6:[function(require,module,exports){"use strict";function noop(){}function getSelectionNullOp(){return{removeAllRanges:noop,addRange:noop}}module.exports=getSelectionNullOp},{}],7:[function(require,module,exports){(function(global){"use strict";function getSelectionRaw(){return global.getSelection()}module.exports=getSelectionRaw}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],8:[function(require,module,exports){(function(global){"use strict";function GetSelection(selection){var self=this,range=selection.createRange();this._selection=selection,this._ranges=[],"Control"===selection.type?updateControlSelection(self):isTextRange(range)?updateFromTextRange(self,range):updateEmptySelection(self)}function createControlSelection(sel,ranges){for(var el,controlRange=body.createControlRange(),i=0,len=ranges.length;len>i;++i){el=getSingleElementFromRange(ranges[i]);try{controlRange.add(el)}catch(e){throw new Error("setRanges(): Element could not be added to control selection")}}controlRange.select(),updateControlSelection(sel)}function removeRangeManually(sel,range){var ranges=sel.getAllRanges();sel.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)isSameRange(range,ranges[i])||sel.addRange(ranges[i]);sel.rangeCount||updateEmptySelection(sel)}function updateAnchorAndFocusFromRange(sel,range){var anchorPrefix="start",focusPrefix="end";sel.anchorNode=range[anchorPrefix+"Container"],sel.anchorOffset=range[anchorPrefix+"Offset"],sel.focusNode=range[focusPrefix+"Container"],sel.focusOffset=range[focusPrefix+"Offset"]}function updateEmptySelection(sel){sel.anchorNode=sel.focusNode=null,sel.anchorOffset=sel.focusOffset=0,sel.rangeCount=0,sel.isCollapsed=!0,sel._ranges.length=0}function rangeContainsSingleElement(rangeNodes){if(!rangeNodes.length||1!==rangeNodes[0].nodeType)return!1;for(var i=1,len=rangeNodes.length;len>i;++i)if(!isAncestorOf(rangeNodes[0],rangeNodes[i]))return!1;return!0}function getSingleElementFromRange(range){var nodes=range.getNodes();if(!rangeContainsSingleElement(nodes))throw new Error("getSingleElementFromRange(): range did not consist of a single element");return nodes[0]}function isTextRange(range){return range&&void 0!==range.text}function updateFromTextRange(sel,range){sel._ranges=[range],updateAnchorAndFocusFromRange(sel,range,!1),sel.rangeCount=1,sel.isCollapsed=range.collapsed}function updateControlSelection(sel){if(sel._ranges.length=0,"None"===sel._selection.type)updateEmptySelection(sel);else{var controlRange=sel._selection.createRange();if(isTextRange(controlRange))updateFromTextRange(sel,controlRange);else{sel.rangeCount=controlRange.length;for(var range,i=0;i<sel.rangeCount;++i)range=doc.createRange(),range.selectNode(controlRange.item(i)),sel._ranges.push(range);sel.isCollapsed=1===sel.rangeCount&&sel._ranges[0].collapsed,updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],!1)}}}function addRangeToControlSelection(sel,range){for(var controlRange=sel._selection.createRange(),rangeElement=getSingleElementFromRange(range),newControlRange=body.createControlRange(),i=0,len=controlRange.length;len>i;++i)newControlRange.add(controlRange.item(i));try{newControlRange.add(rangeElement)}catch(e){throw new Error("addRange(): Element could not be added to control selection")}newControlRange.select(),updateControlSelection(sel)}function isSameRange(left,right){return left.startContainer===right.startContainer&&left.startOffset===right.startOffset&&left.endContainer===right.endContainer&&left.endOffset===right.endOffset}function isAncestorOf(ancestor,descendant){for(var node=descendant;node.parentNode;){if(node.parentNode===ancestor)return!0;node=node.parentNode}return!1}function getSelection(){return new GetSelection(global.document.selection)}var rangeToTextRange=require("./rangeToTextRange"),doc=global.document,body=doc.body,GetSelectionProto=GetSelection.prototype;GetSelectionProto.removeAllRanges=function(){var textRange;try{this._selection.empty(),"None"!==this._selection.type&&(textRange=body.createTextRange(),textRange.select(),this._selection.empty())}catch(e){}updateEmptySelection(this)},GetSelectionProto.addRange=function(range){"Control"===this._selection.type?addRangeToControlSelection(this,range):(rangeToTextRange(range).select(),this._ranges[0]=range,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,updateAnchorAndFocusFromRange(this,range,!1))},GetSelectionProto.setRanges=function(ranges){this.removeAllRanges();var rangeCount=ranges.length;rangeCount>1?createControlSelection(this,ranges):rangeCount&&this.addRange(ranges[0])},GetSelectionProto.getRangeAt=function(index){if(0>index||index>=this.rangeCount)throw new Error("getRangeAt(): index out of bounds");return this._ranges[index].cloneRange()},GetSelectionProto.removeRange=function(range){if("Control"!==this._selection.type)return void removeRangeManually(this,range);for(var el,controlRange=this._selection.createRange(),rangeElement=getSingleElementFromRange(range),newControlRange=body.createControlRange(),removed=!1,i=0,len=controlRange.length;len>i;++i)el=controlRange.item(i),el!==rangeElement||removed?newControlRange.add(controlRange.item(i)):removed=!0;newControlRange.select(),updateControlSelection(this)},GetSelectionProto.eachRange=function(fn,returnValue){var i=0,len=this._ranges.length;for(i=0;len>i;++i)if(fn(this.getRangeAt(i)))return returnValue},GetSelectionProto.getAllRanges=function(){var ranges=[];return this.eachRange(function(range){ranges.push(range)}),ranges},GetSelectionProto.setSingleRange=function(range){this.removeAllRanges(),this.addRange(range)},module.exports=getSelection}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./rangeToTextRange":10}],9:[function(require,module,exports){"use strict";function isHostMethod(host,prop){var type=typeof host[prop];return"function"===type||!("object"!==type||!host[prop])||"unknown"===type}function isHostProperty(host,prop){return"undefined"!=typeof host[prop]}function many(fn){return function(host,props){for(var i=props.length;i--;)if(!fn(host,props[i]))return!1;return!0}}module.exports={method:isHostMethod,methods:many(isHostMethod),property:isHostProperty,properties:many(isHostProperty)}},{}],10:[function(require,module,exports){(function(global){"use strict";function rangeToTextRange(p){if(p.collapsed)return createBoundaryTextRange({node:p.startContainer,offset:p.startOffset},!0);var startRange=createBoundaryTextRange({node:p.startContainer,offset:p.startOffset},!0),endRange=createBoundaryTextRange({node:p.endContainer,offset:p.endOffset},!1),textRange=body.createTextRange();return textRange.setEndPoint("StartToStart",startRange),textRange.setEndPoint("EndToEnd",endRange),textRange}function isCharacterDataNode(node){var t=node.nodeType;return 3===t||4===t||8===t}function createBoundaryTextRange(p,starting){var bound,parent,workingNode,childNodes,offset=p.offset,range=body.createTextRange(),data=isCharacterDataNode(p.node);return data?(bound=p.node,parent=bound.parentNode):(childNodes=p.node.childNodes,bound=offset<childNodes.length?childNodes[offset]:null,parent=p.node),workingNode=doc.createElement("span"),workingNode.innerHTML="&#feff;",bound?parent.insertBefore(workingNode,bound):parent.appendChild(workingNode),range.moveToElementText(workingNode),range.collapse(!starting),parent.removeChild(workingNode),data&&range[starting?"moveStart":"moveEnd"]("character",offset),range}var doc=global.document,body=doc.body;module.exports=rangeToTextRange}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],11:[function(require,module,exports){"use strict";var getSelection=require("./getSelection"),setSelection=require("./setSelection");module.exports={get:getSelection,set:setSelection}},{"./getSelection":5,"./setSelection":12}],12:[function(require,module,exports){(function(global){"use strict";function setSelection(p){function modernSelection(){var sel=getSelection(),range=doc.createRange();p.startContainer&&(p.endContainer?range.setEnd(p.endContainer,p.endOffset):range.setEnd(p.startContainer,p.startOffset),range.setStart(p.startContainer,p.startOffset),sel.removeAllRanges(),sel.addRange(range))}function oldSelection(){rangeToTextRange(p).select()}doc.createRange?modernSelection():oldSelection()}var getSelection=require("./getSelection"),rangeToTextRange=require("./rangeToTextRange"),doc=global.document;module.exports=setSelection}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./getSelection":5,"./rangeToTextRange":10}],13:[function(require,module,exports){"use strict";function easyGet(el){return{start:el.selectionStart,end:el.selectionEnd}}function hardGet(el){function result(start,end){return active!==el&&(active?active.focus():el.blur()),{start:start,end:end}}var active=document.activeElement;active!==el&&el.focus();var range=document.selection.createRange(),bookmark=range.getBookmark(),original=el.value,marker=getUniqueMarker(original),parent=range.parentElement();if(null===parent||!inputs(parent))return result(0,0);range.text=marker+range.text+marker;var contents=el.value;return el.value=original,range.moveToBookmark(bookmark),range.select(),result(contents.indexOf(marker),contents.lastIndexOf(marker)-marker.length)}function getUniqueMarker(contents){var marker;do marker="@@marker."+Math.random()*new Date;while(-1!==contents.indexOf(marker));return marker}function inputs(el){return"INPUT"===el.tagName&&"text"===el.type||"TEXTAREA"===el.tagName}function easySet(el,p){el.selectionStart=parse(el,p.start),el.selectionEnd=parse(el,p.end)}function hardSet(el,p){var range=el.createTextRange();"end"===p.start&&"end"===p.end?(range.collapse(!1),range.select()):(range.collapse(!0),range.moveEnd("character",parse(el,p.end)),range.moveStart("character",parse(el,p.start)),range.select())}function parse(el,value){return"end"===value?el.value.length:value||0}function sell(el,p){return 2===arguments.length&&set(el,p),get(el)}var get=easyGet,set=easySet;document.selection&&document.selection.createRange&&(get=hardGet,set=hardSet),module.exports=sell},{}],14:[function(require,module,exports){(function(global){"use strict";function tailormade(el,options){function noop(){}function readPosition(){return(textInput?coordsText:coordsHTML)()}function refresh(){return o.sleeping?void 0:(o.update||noop)(readPosition())}function coordsText(){var p=sell(el),context=prepare(),readings=readTextCoords(context,p.start);return doc.body.removeChild(context.mirror),readings}function coordsHTML(){var sel=getSelection();if(sel.rangeCount){var range=sel.getRangeAt(0),needsToWorkAroundNewlineBug="P"===range.startContainer.nodeName&&0===range.startOffset;if(needsToWorkAroundNewlineBug)return{x:range.startContainer.offsetLeft,y:range.startContainer.offsetTop,absolute:!0};if(range.getClientRects){var rects=range.getClientRects();if(rects.length>0)return{x:rects[0].left,y:rects[0].top,absolute:!0}}}return{x:0,y:0}}function readTextCoords(context,p){var rest=doc.createElement("span"),mirror=context.mirror,computed=context.computed;return write(mirror,read(el).substring(0,p)),"INPUT"===el.tagName&&(mirror.textContent=mirror.textContent.replace(/\s/g," ")),write(rest,read(el).substring(p)||"."),mirror.appendChild(rest),{x:rest.offsetLeft+parseInt(computed.borderLeftWidth),y:rest.offsetTop+parseInt(computed.borderTopWidth)}}function read(el){return textInput?el.value:el.innerHTML}function prepare(){function copy(prop){style[prop]=computed[prop]}var computed=win.getComputedStyle?getComputedStyle(el):el.currentStyle,mirror=doc.createElement("div"),style=mirror.style;return doc.body.appendChild(mirror),"INPUT"!==el.tagName&&(style.wordWrap="break-word"),style.whiteSpace="pre-wrap",style.position="absolute",style.visibility="hidden",props.forEach(copy),ff?(style.width=parseInt(computed.width)-2+"px",el.scrollHeight>parseInt(computed.height)&&(style.overflowY="scroll")):style.overflow="hidden",{mirror:mirror,computed:computed}}function write(el,value){textInput?el.textContent=value:el.innerHTML=value}function bind(remove){var op=remove?"remove":"add";crossvent[op](el,"keydown",throttledRefresh),crossvent[op](el,"keyup",throttledRefresh),crossvent[op](el,"input",throttledRefresh),crossvent[op](el,"paste",throttledRefresh),crossvent[op](el,"change",throttledRefresh)}function destroy(){bind(!0)}var textInput="INPUT"===el.tagName||"TEXTAREA"===el.tagName,throttledRefresh=throttle(refresh,30),o=options||{};return bind(),{read:readPosition,refresh:throttledRefresh,destroy:destroy}}var sell=require("sell"),crossvent=require("crossvent"),seleccion=require("seleccion"),throttle=require("./throttle"),getSelection=seleccion.get,props=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],win=global,doc=document,ff=null!==win.mozInnerScreenX&&void 0!==win.mozInnerScreenX;module.exports=tailormade}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./throttle":15,crossvent:3,seleccion:11,sell:13}],15:[function(require,module,exports){"use strict";function throttle(fn,boundary){var timer,last=-(1/0);return function(){function unbound(){clearTimeout(timer),timer=null;var next=last+boundary,now=Date.now();now>next?(last=now,fn()):timer=setTimeout(unbound,next-now)}timer||unbound()}}module.exports=throttle},{}]},{},[1])(1)}),define("auto-complete",["../lib/bullseye"],function(bullseye){return Backbone.View.extend({className:"token-editor-auto-complete",menu:[],_defaultOptions:{items:[],minLen:2,maxResults:4,minScore:.9},events:{"click > div":"onClick"},initialize:function(){this.options=_.extend(this._defaultOptions,this.options||{}),document.body.appendChild(this.el),this.position=bullseye(this.el,this.options.target,{caret:!0,autoupdateToCaret:!0}),this.hide()},setItems:function(items){this.options.items=items},bindKeyboardEvents:function(){this.onKeydown=this.onKeydown||this._onKeydown.bind(this),this.onKeyup=this.onKeyup||this._onKeyup.bind(this),document.body.addEventListener("keydown",this.onKeydown,!0),document.body.addEventListener("keyup",this.onKeyup,!0)},unbindKeyboardEvents:function(){document.body.removeEventListener("keydown",this.onKeydown,!0),document.body.removeEventListener("keyup",this.onKeyup,!0)},_onKeydown:function(e){return 27==e.which||38==e.which||40==e.which||13==e.which||9==e.which?(27==e.which?this.hide():13==e.which||9==e.which?this.onSelect():38==e.which?this.selectPrev():40==e.which&&this.selectNext(),e.preventDefault(),e.stopPropagation(),!1):void 0},_onKeyup:function(e){return 27==e.which||38==e.which||40==e.which||13==e.which?(e.preventDefault(),e.stopPropagation(),!1):void 0},selectPrev:function(){this._selectIndex(this.selected-1<0?this.menu.length-1:this.selected-1)},selectNext:function(){this._selectIndex(this.selected+1>=this.menu.length?0:this.selected+1)},_selectIndex:function(indx){this.el.childNodes[this.selected].classList.remove("selected"),this.el.childNodes[indx].classList.add("selected"),this.selected=indx},onClick:function(e){Modal.alert("Use the <u>up</u> and <u>down</u> keys and press <code>enter</code> to select.")},onSelect:function(){this.trigger("select",this.menu[this.selected],this)},render:function(word){this.$el.html(""),!word||word.length<this.options.minLen?this.hide():(this.menuFor(word),this.menu.length>0&&(this.show(),this.selected=0,this.menu.forEach(this.addMenuItem.bind(this))))},addMenuItem:function(m,indx){this.$el.append('<div class="'+(indx==this.selected?"selected":"")+'" data=id="'+m.id+'">'+m.label+"</div>")},_score:function(str,term){return"undefined"!=typeof LiquidMetal||this._noScoreWarning?LiquidMetal.score(str,term):(this._noScoreWarning=!0,console.warn("TokenEditor: cannot score auto complete results; LiquidMetal plugin is missing."),1)},_scoreItem:function(m,word){var scores=[];return scores.push(this._score(m.label,word)),m.hint&&"string"==typeof m.hint&&scores.push(this._score(m.hint,word)),m.hint&&Array.isArray(m.hint)&&m.hint.forEach(function(str){scores.push(this._score(str,word))}),scores.sort().pop()},menuFor:function(word){var menu=[];return this.options.items&&this.options.items.forEach(function(m){var score=this._scoreItem(m,word);score>=this.options.minScore&&(m.score=score,menu.push(m))}.bind(this)),_.sortBy(menu,function(m){return m.score}),this.menu=menu},show:function(){this.isShowing||(this.isShowing=!0,this.el.classList.add("show"),this.bindKeyboardEvents(),this.position.refresh())},hide:function(){this.isShowing=!1,this.el.classList.remove("show"),this.unbindKeyboardEvents(),this.position.sleep()}})}),define("token-editor",["auto-complete"],function(AutoCompleteView){return Backbone.View.extend({className:"token-editor",_defaultOptions:{className:"",value:"",autoComplete:{},multiLines:!0,allowPaste:!1,allowStyling:!1,editing:!1,dblClickToEdit:!0},events:{dblclick:"onDblClick",click:"onClick",blur:"onBlur",keydown:"onKeydown",keyup:"onKeyup",keypress:"onKeypress",paste:"onPaste"},initialize:function(){window.tokenEditor=this,this.options=_.extend({},this._defaultOptions,this.options||{}),this.history=[],this.historyAt=0,this.options.className&&this.el.classList.add(this.options.className);var autoCompleteOptions=this.options.autoComplete;autoCompleteOptions.target=this.el,this.subview("auto-complete")||this.subview("auto-complete",new AutoCompleteView(autoCompleteOptions)),this.listenTo(this.subview("auto-complete"),"select",this.onAutoCompleteSelect),this.options.items&&this.setAutoCompleteItems(this.options.items),this.setValue(),this.markHistory(),this.options.editing&&this.edit()},isEditing:function(){return"true"==this.el.contentEditable},edit:function(doEdit){this.el.contentEditable=doEdit!==!1},render:function(){return this.delegateEvents(),this},setValue:function(val){0==arguments.length?val=this.options.value:this.options.value=val;var html="string"==typeof val?val:this.jsonToHTML(val);this.el.innerHTML=html,html?this.el.classList.remove("empty"):this.el.classList.add("empty"),this.endWithBrTag()},setAutoCompleteItems:function(items){this.items=items,this.subview("auto-complete").setItems(items)},onAutoCompleteSelect:function(data,autoComplete){autoComplete.hide(),this.replaceWithToken(data)},onDblClick:function(){1!=this.options.dblClickToEdit||this.isEditing()||(this.edit(!0),this.focusEnd())},onClick:function(){this.subview("auto-complete").hide()},onBlur:function(){this.subview("auto-complete").hide(),this.trigger("blur",this)},makeToken:function(d){var node=document.createElement("span");node.contentEditable=!1,node.classList.add("token"),_.each(d.attrs,function(val,key){node.setAttribute("data-"+key,val)});var label=document.createElement("span");return label.innerHTML=d.label,node.appendChild(label),node.outerHTML},insertToken:function(d){this.insertHTML(this.makeToken(d))},replaceWithToken:function(token){clearTimeout(this.historyTimeout);var sel=window.getSelection(),range=sel.getRangeAt(0),text=range.endContainer.textContent.slice(0,range.endOffset),lastSpace=text.lastIndexOf(" ")>-1?text.lastIndexOf(" "):text.lastIndexOf(" ");word=lastSpace>-1?text.slice(lastSpace+1):text,range.setStart(range.endContainer,lastSpace+1),range.deleteContents(),this.insertToken(token)},currentWord:function(){var sel=window.getSelection(),range=sel.getRangeAt(0);if(range.endContainer!=this.el&&range.endContainer.textContent){var text=range.endContainer.textContent.slice(0,range.endOffset),lastSpace=text.lastIndexOf(" ")>-1?text.lastIndexOf(" "):text.lastIndexOf(" ");return word=lastSpace>-1?text.slice(lastSpace+1):text,word}},onPaste:function(e){return 1!=this.options.allowPaste?(e.preventDefault(),!1):void this.markHistoryIn(0)},onKeydown:function(e){if(27===e.which)return void this.trigger("cancel",this);if(this.metaKey()&&(66===e.keyCode||73===e.keyCode)){if(this.options.allowStyling!==!0)return!1;this.markHistoryIn(0)}return this.metaKey()&&90===e.keyCode?(e.shiftKey?this.redo():this.undo(),!1):13===e.keyCode?1!=this.options.multiLines?!1:(this.getSelection().start>=this.length()?document.execCommand("insertHTML",!1,'<br class="newline"><br>'):document.execCommand("insertHTML",!1,'<br class="newline">'),this.markHistoryIn(0),!1):void 0},onKeyup:function(e){_.defer(function(){this.subview("auto-complete").render(this.currentWord())}.bind(this)),8==e.which&&this.markHistoryIn(500),clearTimeout(this.keyupTimeout),this.keyupTimeout=setTimeout(this.endWithBrTag.bind(this),300)},onKeypress:function(e){this.markHistoryIn(500)},endWithBrTag:function(){if(!this.subview("auto-complete").isShowing&&!this.el.innerHTML.match(/<br>$/)){this.isInFocus()||this.focusEnd();var sel=window.getSelection();if("None"==sel.type)return void this.el.appendChild(document.createElement("br"));var range=sel.getRangeAt(0),frag=document.createDocumentFragment(),br=frag.appendChild(document.createElement("br"));this.el.appendChild(frag),range=range.cloneRange(),range.setStartBefore(br),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range)}},insertHTML:function(html){if(this.isInFocus()||this.focusEnd(),sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0),range.deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&(range=range.cloneRange(),range.setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range)),this.markHistory()}},length:function(){return this.el.innerText.trim().replace(/\n/g,"").length},isInFocus:function(){return document.activeElement==this.el},focus:function(atChar){(void 0===atChar||0>atChar||atChar>this.length())&&(atChar=0),this.setSelection(atChar,atChar)},focusEnd:function(){this.focus(this.length())},selectAll:function(){this.setSelection(0,this.length())},jsonToHTML:function(json){var self=this,lines=_.map(json,function(row){return _.reduce(row,function(str,d){return"string"==typeof d?str+d:void 0!==d.label?str+self.makeToken(d):str+self._objectTextareaObjectToHTML(d)},"")});return lines.join('<br class="newline">')},_objectTextareaObjectToHTML:function(d){if("text"==d.type)return d.data.text;var attrs=_.clone(d.data),label=d.data.text;return delete attrs.text,this.makeToken({label:label,attrs:attrs})},toHTML:function(){return this.el.innerHTML.replace(/<br>$/,"")},toString:function(lineSeparator){lineSeparator=lineSeparator||"\n";var html=_.stripTags(this.toHTML().replace(/<br class="newline">/g,"||"));return html.replace(/\|\|/g,lineSeparator)},toJSON:function(){var html=this.toHTML();if(!html)return[];var json=html.split('<br class="newline">');return json=_.map(json,function(str){var div=document.createElement("div");div.innerHTML=str;var row=[];return _.each(div.childNodes,function(node){node.tagName?"SPAN"==node.tagName&&row.push({label:node.textContent,attrs:_.clone(node.dataset)}):row.push(node.textContent)}),row})},toObjectTextarea:function(){var json=this.toJSON();return _.map(json,function(row){return _.map(row,function(d){if("string"==typeof d)return{type:"text",data:{text:d}};var attrs=d.attrs;return attrs.text=d.label,{type:"bubble",data:attrs}})})},setSelection:function(start,end){var startNode,endNode,range=document.createRange(),count=0;_.each(this.el.childNodes,function(node,indx){var len=(node.innerText?node.innerText.length:node.length)||0;count+=len,(count>start||count==start&&0==len)&&!startNode&&(startNode=node,range.setStart(node,node.tagName?0:start-(count-len))),(count>end||count==end&&0==len)&&!endNode&&(endNode=node,node.tagName&&len>0?node.nextSibling?range.setEnd(node.nextSibling,0):range.setEnd(node,0):range.setEnd(node,end-(count-len)))}),this.el.focus();var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)},getSelection:function(){var sel=window.getSelection();if("None"==sel.type)return{start:this.length(),end:this.length()};var range=sel.getRangeAt(0),preSelectionRange=range.cloneRange();preSelectionRange.selectNodeContents(this.el),preSelectionRange.setEnd(range.startContainer,range.startOffset);var start=preSelectionRange.toString().length;return{start:start,end:start+range.toString().length}},metaKey:function(e){return e=e||event,e&&(e.ctrlKey||e.altKey||e.metaKey)},markHistory:function(){this.history.splice(this.historyAt+1,Number.MAX_VALUE,{caret:this.getSelection(),content:this.el.innerHTML}),this.historyAt=this.history.length-1},markHistoryIn:function(ms){clearTimeout(this.historyTimeout),this.historyTimeout=setTimeout(this.markHistory.bind(this),ms||0)},undo:function(){this.historyAt<=0||this.applyHistory(this.history[--this.historyAt])},redo:function(){this.historyAt>=this.history.length-1||this.applyHistory(this.history[++this.historyAt])},applyHistory:function(hist){this.el.innerHTML=hist.content,this.setSelection(hist.caret.start,hist.caret.end)}})});
//# sourceMappingURL=token-editor.min.js.map